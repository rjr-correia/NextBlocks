{"version":3,"file":"codestring.min.js","sources":["../src/codestring.js"],"sourcesContent":["/**\n *\n * @module      mod_nextblocks/codestring\n * @copyright   2023 Duarte Pereira<dg.pereira@campus.fct.unl.pt>\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n\n    class CodeString {\n        #codeString;\n        #userFunctionLinesCount;\n\n        static #auxFunctions =\n            `\n\ncustomPrintln = function(string) {\n  outputString += string + '\\\\n';\n  updateTerminal();\n  return string;\n};\n\ncustomPrint = function(string) {\n  outputString += string + ' ';\n  updateTerminal();\n  return string;\n};\n\n\nupdateTerminal = function(){\n  const outputDiv = document.getElementById('output-div');\n  if (outputDiv) {\n    outputDiv.innerHTML = \"\";\n    const pre = document.createElement('pre');\n    pre.style.whiteSpace = 'pre-wrap'; \n    pre.textContent = outputString; \n    outputDiv.appendChild(pre);\n  }\n}\n\nfunction showInputBox() {\n  const inputBox = document.getElementById('input-box');\n  if (inputBox) {\n    inputBox.style.display = 'block';\n    inputBox.focus();\n  }\n}\n\nfunction hideInputBox() {\n  const inputBox = document.getElementById('input-box');\n  if (inputBox) {\n    inputBox.style.display = 'none';\n    inputBox.value = '';\n  }\n}\n\n\n\nasync function input(promptText) {\n  showInputBox();\n  return new Promise((resolve) => {\n    const inputBox = document.getElementById('input-box');\n    const handleKeyDown = (e) => {\n      if (e.key === 'Enter') {\n        e.preventDefault();\n        inputBox.removeEventListener('keydown', handleKeyDown);\n        const answer = inputBox.value.trim();\n        hideInputBox();\n        resolve(answer);\n      }\n    };\n    inputBox.addEventListener('keydown', handleKeyDown);\n  });\n}\n\n\n\n\n`;\n        static #codeEnding = `})();\nreturn outputString;\n})();\n`;\n        constructor(codeString) {\n            if (arguments.length > 0) {\n                this.addAsyncDeclaration();\n                this.#codeString += codeString;\n                this.addVariable('outputString', '\"\"');\n            } else {\n                this.#codeString = '';\n                this.addAsyncDeclaration();\n                this.addVariable('outputString', '\"\"');\n\n\n            }\n            this.#userFunctionLinesCount = 0;\n        }\n\n        getCompleteCodeString() {\n            return this.#codeString;\n        }\n\n        getPrintableCodeString() {\n            // Split code by unescaped line breaks (code might have escaped line breaks)\n            const codeLines = this.#codeString.split(/(?<!\\\\)\\n/);\n\n            // Add lines from user functions\n            const functionLines = codeLines.slice(0, this.#userFunctionLinesCount);\n\n            // Add lines from start block\n            const startIndex = codeLines.findIndex(line => line.includes('(function () {')) + 1;\n            const endIndex = codeLines.findIndex(line => line.includes('return outputString;'));\n            const startCodeLines = codeLines.slice(startIndex, endIndex);\n\n            return functionLines.concat(startCodeLines).join('\\n');\n        }\n\n        getSubmittableCodeString() {\n            // Replace return outputString; with process.stdout.write(outputString);\n            let lastIndex = this.#codeString.lastIndexOf('return outputString;');\n            return this.#codeString.substring(0, lastIndex) + 'process.stdout.write(outputString);' +\n                this.#codeString.substring(lastIndex + 'return outputString;'.length);\n        }\n\n        addVariable(variableName, variableValue) {\n            // Check if variableName is a valid variable name\n            const regex = /^[a-zA-Z_][a-zA-Z0-9_]*$/;\n            if (!regex.test(variableName)) {\n                throw new Error('Invalid variable name');\n            }\n            this.#codeString += 'let ' + variableName + ' = ' + variableValue + ';\\n';\n            return this.#codeString;\n        }\n\n        addAsyncDeclaration() {\n            this.#codeString += '(async () => {\\n';\n            return this.#codeString;\n        }\n\n        addLine(line) {\n            // Check if line does not have line break\n            if (line.includes('\\n')) {\n                throw new Error('Invalid line');\n            }\n            this.#codeString += line + '\\n';\n            return this.#codeString;\n        }\n\n        addEnding() {\n            this.#codeString += CodeString.#codeEnding;\n            return this.#codeString;\n        }\n\n        addAuxFunctions(inputFuncDecs) {\n            const auxFunctions = inputFuncDecs + CodeString.#auxFunctions;\n            this.#codeString += auxFunctions;\n            return this.#codeString;\n        }\n\n        addMainCode(codeString) {\n            this.#codeString += codeString;\n            return this.#codeString;\n        }\n\n        addFunction(functionCode) {\n            // Update user function lines count\n            const regex = /(?<!\\\\)\\n/g;\n            const functionLinesCount = (functionCode.match(regex) || []).length;\n            this.#userFunctionLinesCount += functionLinesCount;\n\n            this.#codeString = functionCode + this.#codeString;\n            return this.#codeString;\n        }\n    }\n    return CodeString;\n});\n"],"names":["define","CodeString","constructor","codeString","arguments","length","addAsyncDeclaration","addVariable","getCompleteCodeString","getPrintableCodeString","codeLines","split","functionLines","slice","startIndex","findIndex","line","includes","endIndex","startCodeLines","concat","join","getSubmittableCodeString","lastIndex","lastIndexOf","substring","variableName","variableValue","regex","test","Error","addLine","addEnding","addAuxFunctions","inputFuncDecs","auxFunctions","addMainCode","addFunction","functionCode","functionLinesCount","match"],"mappings":"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"}